<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Water Quality Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            color: white;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .summary-cards {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 250px;
            text-align: center;
        }

        .card h4 {
            color: #444;
            margin-bottom: 10px;
        }

        .card span {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
        }

        select,
        button {
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            background-color: #667eea;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #5a67d8;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        canvas {
            max-width: 100%;
            height: 250px !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Users' Water Quality Dashboard</h1>
    </div>

    <div class="controls">
        <select id="userSelector">
            <option value="">Select a user</option>
        </select>
        <button onclick="loadCharts()">Load Data</button>
    </div>

    <div class="summary-cards">
        <div class="card">
            <h4>Latest Water Level</h4>
            <span id="latestWater">-- %</span>
        </div>
        <div class="card">
            <h4>Latest TDS</h4>
            <span id="latestTDS">-- ppm</span>
        </div>
        <div class="card">
            <h4>Latest Flow Rate</h4>
            <span id="latestFlow">-- L/min</span>
        </div>
        <div class="card">
            <h4>Latest Volume</h4>
            <span id="latestVolume">-- L</span>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3 style="text-align: center;">Water Level Over Time</h3>
            <canvas id="waterLevelChart"></canvas>
        </div>

        <div class="chart-container">
            <h3 style="text-align: center;">TDS Level Over Time</h3>
            <canvas id="tdsChart"></canvas>
        </div>

        <div class="chart-container">
            <h3 style="text-align: center;">Flow Rate Over Time</h3>
            <canvas id="flowChart"></canvas>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3yARNAUvpg2Q5ym2euy8Dafy3ecqo5yM",
            authDomain: "watermonitoringsystem-d232c.firebaseapp.com",
            databaseURL: "https://watermonitoringsystem-d232c-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "watermonitoringsystem-d232c",
            storageBucket: "watermonitoringsystem-d232c.firebasestorage.app",
            messagingSenderId: "1041155714114",
            appId: "1:1041155714114:web:134bad725d3b2bb4d2d1db",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let waterLevelChart, tdsChart, flowChart;

        function createLineChart(ctx, label, color) {
            return new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: label,
                            data: [],
                            fill: true,
                            backgroundColor: color + "33",
                            borderColor: color,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: color,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: "#333",
                                font: {
                                    size: 14,
                                },
                            },
                        },
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "Time",
                                color: "#555",
                            },
                            ticks: {
                                color: "#777",
                            },
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: "#777",
                            },
                            title: {
                                display: true,
                                text: label,
                                color: "#555",
                            },
                        },
                    },
                },
            });
        }

        function loadUserList() {
            db.ref("users")
                .once("value")
                .then((snapshot) => {
                    const users = snapshot.val();
                    const selector = document.getElementById("userSelector");
                    if (users) {
                        Object.keys(users).forEach((uid) => {
                            const user = users[uid];
                            const option = document.createElement("option");
                            option.value = uid;
                            option.textContent = `${user.firstName} ${user.lastName}`;
                            selector.appendChild(option);
                        });
                    }
                });
        }

        function loadCharts() {
            const userId = document.getElementById("userSelector").value;
            if (!userId) return alert("Please select a user.");

            const sensorsRef = db.ref("sensors/" + userId);

            sensorsRef.once("value").then((snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    alert("No data available for this user.");
                    return;
                }

                const labels = [],
                    waterLevel = [],
                    tds = [],
                    flow = [],
                    volume = [];

                Object.keys(data)
                    .sort()
                    .forEach((key) => {
                        const entry = data[key];
                        const timeLabel = new Date(Number(key)).toLocaleTimeString();
                        labels.push(timeLabel);
                        waterLevel.push(entry.waterLevel || 0);
                        tds.push(entry.tds || 0);
                        flow.push(entry.flow || 0);
                        volume.push(entry.volume || 0);
                    });

                document.getElementById("latestWater").innerText =
                    (waterLevel.at(-1) ?? "--") + " %";
                document.getElementById("latestTDS").innerText =
                    (tds.at(-1) ?? "--") + " ppm";
                document.getElementById("latestFlow").innerText =
                    (flow.at(-1) ?? "--") + " L/min";
                document.getElementById("latestVolume").innerText =
                    (volume.at(-1) ?? "--") + " L";

                if (waterLevelChart) {
                    waterLevelChart.data.labels = labels;
                    waterLevelChart.data.datasets[0].data = waterLevel;
                    waterLevelChart.update();

                    tdsChart.data.labels = labels;
                    tdsChart.data.datasets[0].data = tds;
                    tdsChart.update();

                    flowChart.data.labels = labels;
                    flowChart.data.datasets[0].data = flow;
                    flowChart.update();
                } else {
                    waterLevelChart = createLineChart(
                        document.getElementById("waterLevelChart"),
                        "Water Level (%)",
                        "#4f46e5"
                    );
                    tdsChart = createLineChart(
                        document.getElementById("tdsChart"),
                        "TDS (ppm)",
                        "#d97706"
                    );
                    flowChart = createLineChart(
                        document.getElementById("flowChart"),
                        "Flow Rate (L/min)",
                        "#dc2626"
                    );

                    waterLevelChart.data.labels = labels;
                    waterLevelChart.data.datasets[0].data = waterLevel;
                    waterLevelChart.update();

                    tdsChart.data.labels = labels;
                    tdsChart.data.datasets[0].data = tds;
                    tdsChart.update();

                    flowChart.data.labels = labels;
                    flowChart.data.datasets[0].data = flow;
                    flowChart.update();
                }
            });
        }

        loadUserList();
    </script>
</body>
</html>
